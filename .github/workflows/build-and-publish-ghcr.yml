name: Build and Push to GHCR

on:
  push:
    branches:
      - main
      - feature/openshift-deployment
    paths:
      - 'Dockerfile'
      - '.dockerignore'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'src/**'
      - 'hosts.example.yaml'
      - '.github/workflows/build-and-publish-ghcr.yml'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: rrbanda
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push container image
        run: |
          IMAGE_NAME=ghcr.io/rrbanda/linux-mcp-server:latest
          IMAGE_SHA=ghcr.io/rrbanda/linux-mcp-server:${{ github.sha }}
          
          echo "üî® Building image: $IMAGE_NAME"
          podman build -f Dockerfile -t $IMAGE_NAME -t $IMAGE_SHA .
          
          echo "üì§ Pushing images to GHCR..."
          podman push $IMAGE_NAME
          podman push $IMAGE_SHA
          
          echo "‚úÖ Successfully built and pushed Linux MCP Server images:"
          echo "  üì¶ $IMAGE_NAME"
          echo "  üì¶ $IMAGE_SHA"

      - name: Set GHCR Package Visibility to Public
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PACKAGE_NAME: linux-mcp-server
          PACKAGE_TYPE: container
        run: |
          echo "üîì Making GHCR package public..."
          
          # Get the Package ID using GitHub CLI
          PACKAGE_ID=$(gh api \
            --header 'Accept: application/vnd.github.v3+json' \
            /users/rrbanda/packages/${{ env.PACKAGE_TYPE }}/${{ env.PACKAGE_NAME }} \
            --jq '.id')
          
          if [ -z "$PACKAGE_ID" ]; then
            echo "‚ö†Ô∏è  Could not find package ID for ${{ env.PACKAGE_NAME }}"
            echo "Package may not exist yet or visibility setting may require manual action on first run"
            exit 0
          fi
          
          echo "üì¶ Found Package ID: $PACKAGE_ID"
          
          # Use the REST API to set the visibility to public
          # Must use the package ID in the URL path
          curl -L \
            -X PATCH \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ env.GH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"visibility": "public"}' \
            https://api.github.com/users/rrbanda/packages/${{ env.PACKAGE_TYPE }}/${{ env.PACKAGE_NAME }}
          
          echo ""
          echo "‚úÖ Successfully set package visibility for ${{ env.PACKAGE_NAME }} to public"
          echo "üîó View on GHCR: https://github.com/rrbanda/linux-mcp-server/pkgs/container/linux-mcp-server"

