apiVersion: tekton.dev/v1
kind: Task
metadata:
  namespace: rhel-lightspeed-tenant
  name: get-version

spec:
  description: Get version number
  params:
    - name: source_artifact
      description: The Trusted Artifact URI pointing to the artifact with the application source code.
      type: string

  results:
    - name: pseudo_version
      description: Version for use by setuptools-scm

    - name: version
      description: Version that is also a valid container tag

  volumes:
    - name: workdir
      emptyDir: {}

  stepTemplate:
    volumeMounts:
      - name: workdir
        mountPath: /var/workdir

  steps:
    - name: use-trusted-artifact
      image: quay.io/redhat-appstudio/build-trusted-artifacts:latest@sha256:9b180776a41d9a22a1c51539f1647c60defbbd55b44bbebdd4130e33512d8b0d
      args:
        - use
        - $(params.source_artifact)=/var/workdir/source

    - name: determine-image-tag
      image: registry.redhat.io/ubi10/s2i-base:latest
      workingDir: /var/workdir/source
      script: |
        #!/usr/bin/env bash
        set -euo pipefail

        python3 -V
        env | sort
        whoami
        pwd
        ls -la
        git status
        git tag

        python3 -m venv .venvs/hatch

        export PATH=".venvs/hatch/bin:$PATH"
        pip install hatch

        pseudo_version="$(hatch version)"
        version="${pseudo_version%%+*}"

        echo -n "$pseudo_version" | tee "$(results.pseudo_version.path)"
        echo -n "$version" | tee "$(results.version.path)"
